from ninja import Schema
from typing import Optional, Dict, List
from datetime import datetime
from vulnerability_analysis.models.app import AppStatus, VulnerabilitySeverity
from vulnerability_analysis.models.security import (
    RootStatus, BootloaderStatus, SelinuxStatus, 
    EncryptionStatus, EnableDeviceStatus
)


class AppVulnerabilitySchema(Schema):
    title: str
    vulnerability: str
    description: Optional[str] = None
    severity: str = VulnerabilitySeverity.NONE.value

class AppVulnerabilityResponse(AppVulnerabilitySchema):
    id: int
    created_at: datetime
    updated_at: datetime
    last_scanned_at: datetime


class DeviceSecuritySchema(Schema):
    security_score: int = 0
    security_score_description: Optional[str] = None
    root_status: str = RootStatus.UNKNOWN.value
    bootloader_status: str = BootloaderStatus.UNKNOWN.value
    selinux_status: str = SelinuxStatus.UNKNOWN.value
    encryption_status: str = EncryptionStatus.UNKNOWN.value
    screen_lock_status: str = EnableDeviceStatus.UNKNOWN.value
    usb_debug_status: str = EnableDeviceStatus.UNKNOWN.value
    unknown_sources_status: str = EnableDeviceStatus.UNKNOWN.value
    developer_options_status: str = EnableDeviceStatus.UNKNOWN.value

class DeviceSecurityResponse(DeviceSecuritySchema):
    id: int
    device_id: int
    created_at: datetime
    updated_at: datetime
    security_score_updated_at: datetime 

class BaseAppSummarySchema(Schema):
    name: Optional[str] = None
    version: str = "Unknown"
    package_name: str = "Unknown"
    app_id: str = "Unknown"
    app_version_code: str = "Unknown"
    app_version_name: str = "Unknown"
    app_package_name: str = "Unknown"
    description: Optional[str] = None
    status: str = AppStatus.UNKNOWN.value

class AppSummarySchema(BaseAppSummarySchema):
    vulnerabilities: List[AppVulnerabilitySchema] = []

class AppSummaryResponse(AppSummarySchema):
    id: int
    created_at: datetime
    updated_at: datetime
    last_connected_at: Optional[datetime] = None
    last_disconnected_at: Optional[datetime] = None
    vulnerabilities: List[AppVulnerabilityResponse] = []

class DeviceAnalysisSummarySchema(Schema):
    apps: List[AppSummarySchema]
    security: DeviceSecuritySchema

class DeviceAnalysisSummaryResponse(DeviceAnalysisSummarySchema):
    apps: List[AppSummaryResponse]
    security: DeviceSecurityResponse





