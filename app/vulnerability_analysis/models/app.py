from django.db import models
from .device import MobileDevice
from enum import Enum

class AppStatus(Enum):
    CONNECTED = "connected"
    LISTENING = "listening"
    DISCONNECTED = "disconnected"
    UNKNOWN = "unknown"

class VulnerabilitySeverity(Enum):
    NONE = "none"
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"
    CRITICAL = "critical"
    UNKNOWN = "unknown"

class AppVulnerability(models.Model):
    title = models.CharField(max_length=255, unique=True)
    vulnerability = models.CharField(max_length=255)
    description = models.TextField(null=True, blank=True)
    severity = models.CharField(max_length=255, choices=[(severity.value, severity.value) for severity in VulnerabilitySeverity], default=VulnerabilitySeverity.NONE.value)

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    last_scanned_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ["-created_at"]
        verbose_name = "App Vulnerability"
        verbose_name_plural = "App Vulnerabilities"

class AppSummary(models.Model):
    device = models.ForeignKey(MobileDevice, on_delete=models.CASCADE)
    name = models.CharField(max_length=255, null=True, blank=True)
    version = models.CharField(max_length=255, default="Unknown")
    package_name = models.CharField(max_length=255, default="Unknown")
    app_id = models.CharField(max_length=255, default="Unknown")
    app_version_code = models.CharField(max_length=255, default="Unknown")
    app_version_name = models.CharField(max_length=255, default="Unknown")
    app_package_name = models.CharField(max_length=255, default="Unknown")
    description = models.TextField(null=True, blank=True)
    status = models.CharField(max_length=255, choices=[(status.value, status.value) for status in AppStatus], default=AppStatus.UNKNOWN.value)

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    last_connected_at = models.DateTimeField(null=True, blank=True)
    last_disconnected_at = models.DateTimeField(null=True, blank=True)

    vulnerabilities = models.ManyToManyField(AppVulnerability, related_name="apps", blank=True)

    class Meta:
        ordering = ["-created_at"]
        verbose_name = "App Summary"
        verbose_name_plural = "App Summaries"



        ordering = ["-created_at"]
        verbose_name = "App Vulnerability"
        verbose_name_plural = "App Vulnerabilities"